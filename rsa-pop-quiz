from pwn import remote
from sympy import mod_inverse

def calculate_n(p, q):
    return p * q

def calculate_q_from_p_and_n(p, n):
    return n // p

def totient(p, q):
    return (p-1)*(q-1)

def encrypt_text(m, e, n):
    return pow(m, e, n)

def calculate_private_key(p, q, e):
    # Step 1: Calculate n
    n = p * q

    # Step 2: Calculate phi(n)
    phi_n = (p - 1) * (q - 1)

    # Step 3: Compute d (the modular inverse of e mod phi(n))
    d = mod_inverse(e, phi_n)

    return d

def decrypt(p, e, n, ciphertext):
    # Step 1: Calculate q
    q = n // p

    # Step 2: Calculate d
    d = calculate_private_key(p, q, e)

    # Step 3: Decrypt plaintext
    plaintext = pow(ciphertext, d, n)

    return plaintext
    
def decode_flag(plaintext_decimal):
    # Convert to hexadecimal
    plaintext_hex = hex(plaintext_decimal)[2:]  # Remove the '0x' prefix

    # Convert hexadecimal to ASCII (decode from hex to bytes and then decode bytes to string)
    try:
        plaintext_ascii = bytes.fromhex(plaintext_hex).decode('utf-8')
    except UnicodeDecodeError:
        plaintext_ascii = "Invalid ASCII (non-printable characters or encoding error)"

    return plaintext_ascii

# Function to handle interaction with the server
def interact_with_server(host, port):
    print(f"Connecting to {host}:{port}...")
    conn = remote(host, port)  # Establish connection
    attempt = 0

    while True:
        print("Challenge: ", attempt)
        try:
            # Receive message from the server
            message = conn.recv().decode('utf-8').strip()
            print(f"Server: {message}")
            if "IS THIS POSSIBLE and FEASIBLE? (Y/N):" in message:
                attempt += 1
                if attempt in (1, 2, 4, 5, 7, 8):
                    conn.sendline(str("Y").encode('utf-8'))
                else:
                    conn.sendline(str("N").encode('utf-8'))
            elif "#### TIME TO SHOW ME WHAT YOU GOT! ###" in message:
                if attempt == 1:
                    conn.sendline(str(calculate_n(76753, 60413)).encode('utf-8'))
                if attempt == 2:
                    conn.sendline(str(calculate_q_from_p_and_n(54269, 5051846941)).encode('utf-8'))
                if attempt == 4:
                    conn.sendline(str(totient(12611, 66347)).encode('utf-8'))
                if attempt == 5:
                    conn.sendline(str(encrypt_text(6357294171489311547190987615544575133581967886499484091352661406414044440475205342882841236357665973431462491355089413710392273380203038793241564304774271529108729717, 
                                                   3, 29129463609326322559521123136222078780585451208149138547799121083622333250646678767769126248182207478527881025116332742616201890576280859777513414460842754045651093593251726785499360828237897586278068419875517543013545369871704159718105354690802726645710699029936754265654381929650494383622583174075805797766685192325859982797796060391271817578087472948205626257717479858369754502615173773514087437504532994142632207906501079835037052797306690891600559321673928943158514646572885986881016569647357891598545880304236145548059520898133142087545369179876065657214225826997676844000054327141666320553082128424707948750331)).encode('utf-8'))
                if attempt == 7:
                    conn.sendline(str(calculate_private_key(92092076805892533739724722602668675840671093008520241548191914215399824020372076186460768206814914423802230398410980218741906960527104568970225804374404612617736579286959865287226538692911376507934256844456333236362669879347073756238894784951597211105734179388300051579994253565459304743059533646753003894559, 
                                                            97846775312392801037224396977012615848433199640105786119757047098757998273009741128821931277074555731813289423891389911801250326299324018557072727051765547115514791337578758859803890173153277252326496062476389498019821358465433398338364421624871010292162533041884897182597065662521825095949253625730631876637,
                                                            65537)).encode('utf-8'))
                if attempt == 8:
                    encoded_flag = decrypt(153143042272527868798412612417204434156935146874282990942386694020462861918068684561281763577034706600608387699148071015194725533394126069826857182428660427818277378724977554365910231524827258160904493774748749088477328204812171935987088715261127321911849092207070653272176072509933245978935455542420691737433, 
                                              65537,
                                              23952937352643527451379227516428377705004894508566304313177880191662177061878993798938496818120987817049538365206671401938265663712351239785237507341311858383628932183083145614696585411921662992078376103990806989257289472590902167457302888198293135333083734504191910953238278860923153746261500759411620299864395158783509535039259714359526738924736952759753503357614939203434092075676169179112452620687731670534906069845965633455748606649062394293289967059348143206600765820021392608270528856238306849191113241355842396325210132358046616312901337987464473799040762271876389031455051640937681745409057246190498795697239,
                                              13433290949680532374013867441263154634705815037382789341947905025573905974395028146503162155477260989520870175638250366834087929309236841056522311567941474209163559687755762232926539910909326834168973560610986090744435081572047926364479629414399701920441091626046861493465214197526650146669009590360242375313096062285541413327190041808752295242278877995930751460977420696964385608409717277431821765402461515639686537904799084682553530460611519251872463837425068958992042166507373556839377045616866221238932332390930404993242351071392965945718308504231468783743378794612151028803489143522912976113314577732444166162766)
                    conn.sendline(str(encoded_flag).encode('utf-8'))
                    print(decode_flag(encoded_flag))
        except EOFError:
            print("\nServer closed the connection.")
            break
        except Exception as e:
            print(f"Error: {e}")
            break

        

    conn.close()
    print("Connection closed.")

# Main function
def main():
    host = "jupiter.challenges.picoctf.org"
    port = 18821
    interact_with_server(host, port)

if __name__ == "__main__":
    main()
